---
type: container
name: checkout
description: Check out repo to /src (generate an artifact)

container:
  image: get.applatix.io/applatix/axscm:v2.0
  command: "axscm clone %%repo%% /src --commit %%commit%%"

inputs:
  parameters:
    commit:
    repo:
outputs:
  artifacts:
    code:
      path: "/src"

# Generates/outputs an artifact called 'code' using the contents of the /src directory.

---
type: workflow
name: generate_artifact
description: Generate and consume an artifact

inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"

steps:
  - generate:
      template: checkout
  - consume:
      template: consume_artifact
      parameters:
        artifact_to_consume: "%%steps.generate.code%%"

# This example shows how to generate and consume artifacts in a workflow
# The 'consume' step will use the 'code' artifact output by the 'generate' step

---
type: container
name: consume_artifact
description: Uses an artifact as input

container:
  image: "alpine:latest"
  command: sh -c 'ls -la /src && sleep 5'

inputs:
  parameters:
    artifact_to_consume:
  artifacts:
  - from: "%%artifact_to_consume%%"
    path: "/src"

# The input artifact must first be declared as a parameter and then referenced using the 'from' statement
# The input artifact is placed at the /src path

---
type: workflow
name: export_artifact
description: Export an artifact
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"

steps:
  - generate:
      template: checkout

outputs:
  artifacts:
    my_exported_artifact:
      from: "%%steps.generate.code%%"

tags:
  - export_workflow

# This example 'exports' an artifact so that it can be used by other workflows.
# We apply the 'export_workflow' tag to this workflow so that we can reference this workflow and it's artifacts in other workflows
# Only top-level workflows may use tags for exported artifacts.
# To tag artifacts generated by lower level workflows, successively export the artifacts to the top-level workflow.
# The next eample shows how to reference exported artifacts.

---
type: workflow
name: Use exported artifact
description: Use an artifact exported by a top-level workflow
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
steps:
  - consume:
      template: consume_artifact
      parameters:
        artifact_to_consume: "%%artifacts.tag.export_workflow.my_exported_artifact%%"

# This workflow uses the latest artifact exported by the 'export_workflow' workflow above

---
type: workflow
name: upload_to_nexus
description: Upload and download an artifact to/from a Nexus repo
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    # Parameters used by Nexus
    Group:
    Artifact:
    Version:
    Extension:
    Local_path:
    Repo:
    Nexus_host:

steps:
  - checkout:
      template: checkout
  - nexus_upload:
      template: nexus_upload
      parameters:
        artifact_to_upload: "%%steps.checkout.code%%"
  - nexus_download:
      template: nexus_download
  - consume:
      template: consume_artifact
      parameters:
        artifact_to_consume: "%%steps.nexus_download.nexus_artifact%%"

# Configure the Nexus repo from the GUI: Configurations -> Integrations -> Connect Artifact Repository

---
type: container
name: nexus_upload
description: Upload artifact to Nexus

container:
  image: get.applatix.io/nexus:1.0
  command: sh -c 'axnexus --nexus_host %%Nexus_host%% upload --group %%Group%% --artifact %%Artifact%% --art_version %%Version%% --extension %%Extension%% --local_path %%Local_path%% --repo_id %%Repo%%'

inputs:
  parameters:
    Group:
    Artifact:
    Version:
    Extension:
    Local_path:
    Repo:
    Nexus_host:
    artifact_to_upload:
  artifacts:
  - from: "%%artifact_to_upload%%"
    path: "/src"


---
type: container
name: nexus_download
description: Download artifact from Nexus

container:
  image: get.applatix.io/nexus:1.0
  docker_options:
  command: sh -c 'axnexus --nexus_host %%Nexus_host%% download --group %%Group%% --artifact %%Artifact%% --art_version %%Version%% --extension %%Extension%% --local_path %%Local_path%% --repo_id %%Repo%%'

inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    Group:
    Artifact:
    Version:
    Extension:
    Local_path:
    Repo:
    Nexus_host:

outputs:
  artifacts:
    nexus_artifact:
      path: "%%Local_path%%"

